\section{Funzioni e procedure}
\subsection{\texttt{Show\_Conferenze\_By\_Date(DATE,DATE)}}
La funzione \texttt{Show\_Conferenze\_By\_Date} prende IN ingresso due DATE e restituisce l'insieme di tutte le conferenze comprese tra queste:
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace function show_conference_by_date(dataI date, dataF date)
returns setof conferenza as $$
begin
    return query
    select * from conferenza
    where inizio >= dataI and fine <= dataF;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_Conferenze\_By\_Sede(INTEGER)}}
La funzione \texttt{Show\_Conferenze\_By\_Sede} prende IN ingresso la chiave primaria di una sede e restituisce l'insieme di tutte le conferenze ospitate IN quella determinata sede:
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace function show_conferences_by_sede(sede_id int)
returns setof conferenza as $$
begin
    return query
    select * from conferenza
    where id_sede = sede_id;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_comitato\_scientifico(INTEGER)}}
La funzione \texttt{Show\_comitato\_scientifico} prende IN ingresso la chiave primaria di una conferenza e restituisce la lista di tutti i membri organizzatori appartenenti al comitato scientifico della conferenza:
\begin{lstlisting}[language=SQL, style=mystyle]
CREATE OR REPLACE FUNCTION show_comitato_scientifico(conferenza_id integer)
RETURNS SETOF organizzatore
LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    -- Select dei dettagli dell'organizzatore
    SELECT * FROM organizzatore
    WHERE id_organizzatore IN (
        -- Select degli id degli organizzatori appartenenti al comitato scientifico
        SELECT id_organizzatore FROM organizzatore_comitato
        WHERE id_comitato = (
            -- Select dell'id del comitato scientifico della conferenza
            SELECT comitato_s FROM conferenza
            WHERE id_conferenza = conferenza_id
        )
    );
END;
$function$;
\end{lstlisting}
\subsection{\texttt{Show\_comitato\_locale(INTEGER)}}
La funzione \texttt{Show\_comitato\_locale} prende IN ingresso la chiave primaria di una conferenza e restituisce la lista di tutti i membri organizzatori appartenenti al comitato locale della conferenza:
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace function show_comitato_locale(conferenza_id int)
returns setof organizzatore as $$
begin
    return query
    -- Select dei dettagli dell'organizzatore
    select * from organizzatore
    where id_organizzatore in (
        -- Select degli id degli organizzatori appartenenti al comitato locale
        select id_organizzatore from organizzatore_comitato
        where id_comitato = (
            -- Select dell'id del comitato locale della conferenza
            select id_comitato_locale from conferenza
            where id_conferenza = conferenza_id
        )
    );
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_Partecipanti(INTEGER)}}
La funzione \texttt{Show\_Partecipanti} prende IN ingresso la chiave primaria di una conferenza e restituisce tutti i dettagli dei partecipanti di \textit{tutte le sessioni} della conferenza.
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_partecipanti(conferenza_id int)
returns setof partecipante as $$
begin
    return query
    -- Select dei dettagli del partecipante
    select * from partecipante
    where id_partecipante in (
        -- Select degli id dei partecipanti
        select id_partecipante from partecipazione
        where id_sessione in (
            -- Select degli id delle sessioni della conferenza
            select id_sessione from sessione
            where id_conferenza = conferenza_id
        )
    );
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_Sessioni(INTEGER)}}
La funzione \texttt{show\_sessioni} prende IN ingresso la chiave primaria di una conferenza e restituisce tutti i dettagli delle sessioni.
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace function show_sessioni(conferenza_id int)
returns setof sessione as $$
begin
    return query
    select * from sessione
    where id_conferenza = conferenza_id
    order by inizio;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_interventi\_sessione(INTEGER)}}
La funzione \texttt{show\_interventi\_sessione} prende IN ingresso la chiave primaria di una sessione e mostra tutti gli interventi presenti nel programma di tale sessione:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function 
show_interventi_sessione(sessione_id int)
returns table
(
titolo text,
inizio timestamp,
fine timestamp,
abstract text,
speaker text
)  as $$
declare 
    programma integer;
begin
    select id_programma into programma
    from programma
    where id_sessione = sessione_id;

    select titolo,inizio,fine,abstract, s.nome || ' ' || s.cognome as speaker
    from intervento i join speaker s on i.id_speaker = s.id_speaker
    where i.id_programma = programma
    order by inizio;
end;
$$ language plpgsql;
\end{lstlisting}

\subsection{\texttt{Show\_intervalli\_sessione(INTEGER)}}
La funzione \texttt{show\_intervalli\_sessione} prende IN ingresso la chiave primaria di una sessione e mostra tutti gli intervalli presenti nel programma di tale sessione:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function 
show_intervalli_sessione(sessione_id int)
returns table
(
id_intervallo integer,
tipologia intervallo_st,
inizio timestamp,
fine timestamp
)  
as $$
declare 
    programma_id integer;
begin
    select id_programma into programma_id
    from programma
    where id_sessione = sessione_id;

    select id_intervallo,tipologia,inizio,fine
    from intervallo i
    where id_programma = programma_id
    order by inizio;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_eventi\_sociali\_sessione(INTEGER)}}
La funzione \texttt{show\_eventi\_sociali\_sessione} prende IN ingresso la chiave primaria di una sessione e mostra tutti gli intervalli presenti nel programma di tale sessione:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_eventi_sociali_sessione(sessione_id int)
returns table
(
id_evento integer,
tipologia text,
inizio timestamp,
fine timestamp) 
 as $$
declare 
    programma_id integer;
begin
    select id_programma into programma_id
    from programma
    where id_sessione = sessione_id;

    select id_evento,tipologia,inizio,fine
    from evento
    where id_programma = programma_id
    order by inizio;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_keynote\_sessione(INTEGER)}}
La funzione \texttt{show\_keynote\_sessione} prende IN ingresso la chiave primaria di una sessione e mostra i dettagli del keynote speaker, se presente:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_keynote_sessione(sessione_id int)
returns table(
id_speaker integer,
nome text,
cognome text,
titolo text,
email text,
ente text) 
 as $$
declare
    programma_id integer;
begin
    select id_programma into programma_id
    from programma
    where id_sessione = sessione_id;

    select s.id_speaker,s.nome,s.cognome,s.titolo,s.email,e.nome
    from speaker s join ente e on s.id_ente = e.id_ente
    where s.id_speaker = (
        select id_keynote
        from programma
        where id_programma = programma_id
    );
end;
$$ language plpgsql;

\end{lstlisting}
\subsection{\texttt{Show\_Programma(INTEGER)}}
La funzione \texttt{Show\_Programma} prende IN ingresso la chiave primaria di una sessione e restituisce una tabella che mostra tutti gli appuntamenti IN progamma IN ordine cronologico:
\begin{lstlisting}[language=SQL,style=mystyle]
CREATE OR REPLACE FUNCTION show_programma(sessione_id int)
RETURNS TABLE (
    id_entry integer,
    appuntamento text,
    inizio timestamp,
    fine timestamp,
    descrizione text,
    speaker text
)
AS $$
DECLARE
    programma_id integer;
BEGIN
    SELECT id_programma INTO programma_id
    FROM programma
    WHERE id_sessione = sessione_id;

    RETURN QUERY
    SELECT *
    FROM (
        SELECT distinct i.id_intervento AS id_entry,
               'intervento' AS appuntamento,
               i.inizio,
               i.fine,
               i.abstract,
               s.nome || ' ' || s.cognome AS speaker
        FROM intervento i
        JOIN speaker s ON i.id_speaker = s.id_speaker
        WHERE i.id_programma = programma_id

        UNION ALL

        SELECT i2.id_intervallo AS id_entry,
               'intervallo' AS appuntamento,
               i2.inizio,
               i2.fine,
               tipologia::text as descrizione,
               NULL
        FROM intervallo i2
        WHERE i2.id_programma = programma_id

        UNION ALL

        SELECT e.id_evento AS id_entry,
               'evento' AS appuntamento,
               e.inizio,
               e.fine,
               e.tipologia AS descrizione,
               NULL
        FROM evento e
        WHERE e.id_programma = programma_id
    ) AS subquery
    ORDER BY inizio;
END;
$$ LANGUAGE plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Intervento(TEXT,TEXT,TEXT,INTEGER,INTERVAL)}}
La procedura \texttt{Add\_intervento} provvede all'inserimento di un intervento all'interno del programma della sessione. Questa calcola l'orario esatto in cui inserire il nuovo punto sulla base dell'ultimo punto in programma. Se non esistono punti in programma allora l'ora di inizio è calcolato come l'inizio della sessione:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure add_intervento
(titolo text, 
abstract text, 
speaker_id int, 
programma_id int,
durata interval)
as $$
declare
    sessione_id integer;
    fine_prev timestamp;
begin
    select id_sessione into sessione_id
    from programma
    where id_programma = programma_id;

    select max(fine) into fine_prev
    from show_programma(sessione_id);

    if (fine_prev is null) then
        select inizio into fine_prev
        from sessione
        where id_sessione = sessione_id;
    end if;

    insert into intervento(titolo,abstract,id_speaker,id_programma,inizio,fine)
    values (titolo,abstract,speaker,programma,fine_prev,fine_prev+durata);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ language plpgsql;
\end{lstlisting}

\subsection{\texttt{Add\_Intervallo(TEXT,INTEGER,INTERVAL)}}
La procedura \texttt{Add\_Intervallo} provvede all'inserimento di un intervallo all'interno del programma della sessione. Questa calcola l'orario esatto in cui inserire il nuovo punto sulla base dell'ultimo punto in programma. Se non esistono punti in programma allora l'ora di inizio è calcolato come l'inizio della sessione:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure 
add_intervallo(tipologia text , programma_id int, durata interval)
as $$
declare
    sessione_id integer;
    fine_prev timestamp;
begin
    select id_sessione into sessione_id
    from programma
    where id_programma = programma_id;

    select max(fine) into fine_prev
    from show_programma(sessione_id);

    if (fine_prev is null) then
        select inizio into fine_prev
        from sessione
        where id_sessione = sessione_id;
    end if;

    insert into intervallo(tipologia,id_programma,inizio,fine)
    values (tipologia::intervallo_st, programma, fine_prev, fine_prev+durata);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ 
language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Evento(TEXT,INTEGER,INTERVAL)}}
La procedura \texttt{Add\_Evento} provvede all'inserimento di un evento all'interno del programma della sessione. Questa calcola l'orario esatto IN cui inserire il nuovo punto sulla base dell'ultimo punto IN programma. Se non esistono punti IN programma allora l'ora di inizio è calcolato come l'inizio della sessione:
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure 
add_evento
(tipologia text, 
programma_id int, 
durata interval)
as $$
declare
    sessione_id integer;
    fine_prev timestamp;
begin
    select id_sessione into sessione_id
    from programma
    where id_programma = programma_id;

    select max(fine) into fine_prev
    from show_programma(sessione_id);

    if (fine_prev is null) then
        select inizio into fine_prev
        from sessione
        where id_sessione = sessione_id;
    end if;

    insert into evento(tipologia, id_programma, inizio, fine)
    values (tipologia, programma_id, fine_prev, fine_prev+durata);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$
language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Conferenza\_Details(TEXT,TIMESTAMP,TIMESTAMP,INTEGER,TEXT)}}
La funzione \texttt{Add\_Conferenza\_Details} aggiunge una conferenza e restituisce la chiave primaria della nuova conferenza.
\begin{lstlisting}[language=SQL,style=mystyle]
CREATE OR REPLACE FUNCTION add_conferenza_details
(nome text, inizio timestamp, fine timestamp, sede_id integer, abstract text, utente_id integer)
RETURNS integer AS $$
DECLARE
    id integer;
BEGIN
        INSERT INTO conferenza(titolo, inizio, fine, id_sede, descrizione, id_utente) 
        VALUES (nome, inizio, fine, sede_id, abstract,utente_id)
        RETURNING id_conferenza INTO id;
        raise notice 'Inserimento completato';
        RETURN id;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE NOTICE 'Errore nell''inserimento di una conferenza: %', SQLERRM;
            RETURN 0; 
END;
$$ LANGUAGE plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_ente(INTEGER, INTEGER)}}
La procedura \texttt{Add\_ente} provvede all'inserimento di una nuova istituzione tra gli organizzatori di una conferenza.
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure add_ente(ente_id integer, conferenza_id integer)
as $$
begin
    insert into ente_conferenza(id_ente,id_conferenza)
    values (ente_id,conferenza_id);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Sponsorizzazione(INTEGER,NUMERIC,CHAR(3),INTEGER)}}
La procedura \texttt{Add\_Sponsorizzazione} inserisce una nuova sponsorizzazione per la conferenza:
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace procedure add_sponsorizzazione(sponsor_id integer, contributo numeric(1000,2), valuta char(3), conferenza_id integer)
as $$
begin
    insert into sponsorizzazione(id_sponsor,contributo,valuta,id_conferenza)
    values (sponsor_id,contributo,valuta,conferenza_id);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Sessione(TEXT,TIMESTAMP,TIMESTAMP, INTEGER,INTEGER)}}
La procedura \texttt{Add\_Sessione} aggiunge una nuova sessione per la conferenza:
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace procedure add_sessione(titolo text, inizio timestamp, fine timestamp, sala_id integer, conferenza_id integer)
as $$
begin
    insert into sessione(titolo,inizio,fine,id_sala,id_conferenza)
    values (titolo,inizio,fine,sala_id,conferenza_id);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Partecipante(INTEGER, INTEGER)}}
La procedura \texttt{Add\_Partecipante} inserisce un nuovo partecipante alla sessione:
\begin{lstlisting}[language=SQL, style=mystyle]
create or replace procedure add_partecipante(partecipante_id integer, sessione_id integer)
as $$
begin
    insert into partecipante_sessione(id_partecipante,id_sessione)
    values (partecipante_id,sessione_id);
    raise notice 'Inserimento completato';
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Enti(INTEGER,TEXT)}}
\begin{lstlisting}[language=SQL,style=mystyle]
CREATE OR REPLACE PROCEDURE add_enti(conferenza_id integer, sigle text)
AS $$
DECLARE
    sigla_ente text;
    ente_id integer;
BEGIN
        FOR sigla_ente IN SELECT unnest(string_to_array(sigle, ',')) LOOP
            -- Cerca l'id dell'ente corrispondente alla sigla
            SELECT id_ente INTO ente_id FROM ente WHERE sigla = sigla_ente;
            
            -- Inserisci la tupla (id_ente, conferenza) nella tabella ente_conferenza
            INSERT INTO ente_conferenza(id_ente, id_conferenza) VALUES (ente_id, conferenza_id);
        END LOOP;
        RAISE NOTICE 'Inserimento completato';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE EXCEPTION 'Errore durante l''inserimento delle tuple nella tabella ente_conferenza: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Conferenza}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure add_conferenza(nome text, inizio timestamp, fine timestamp, sede integer, descrizione text, sigle text, utente integer)
as $$
declare
    id_conferenza int;
begin
    id_conferenza := add_conferenza_details(nome,inizio,fine,sede,descrizione,utente);
    call add_enti(id_conferenza,sigle);
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$ language plpgsql;

\end{lstlisting}
\subsection{\texttt{Slitta\_Conferenza(INTERVAL)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure 
	slitta_conferenza(conferenza_id integer, durata interval)
	as $$
	declare
		sessione_id integer;
		intervento_id integer;
		evento_id integer;
		intervallo_id integer;
		sessioni cursor for 
			select id_sessione 
			from sessione 
			where id_conferenza = conferenza_id;
			
		interventi cursor for
			select id_intervento 
			from intervento i join programma p 
			on i.id_programma = p.id_programma 
			where p.id_sessione in 
			(select id_sessione 
			from sessione 
			where id_conferenza = conferenza_id);
			
		intervalli cursor for
			select id_intervallo 
			from intervallo i join programma p 
			on i.id_programma = p.id_programma 
			where p.id_sessione in 
				(select id_sessione 
				from sessione 
				where id_conferenza = conferenza_id);
				
		eventi cursor for
			select id_evento 
			from evento e join programma p 
			on e.id_programma = p.id_programma 
			where p.id_sessione in 
				(select id_sessione 
				from sessione 
				where id_conferenza = conferenza_id);
	begin
        alter table conferenza disable trigger all;
        alter table sessione disable trigger all;
        alter table intervento disable trigger all;
        alter table intervallo disable trigger all;
        alter table evento disable trigger all;
        alter table programma disable trigger all;
		update conferenza
		set inizio = inizio + durata, fine = fine + durata
		where id_conferenza = conferenza_id;
	
		open sessioni;
		loop
			fetch sessioni into sessione_id;
			exit when not found;
			
			update sessione
			set inizio = inizio + durata, fine = fine + durata
			where id_sessione = sessione_id;
		
			open interventi;
			loop
				fetch interventi into intervento_id;
				exit when not found;
	
				update intervento
				set inizio = inizio + durata, fine = fine + durata
				where id_intervento = intervento_id ;
			end loop;
			close interventi;
			
			open intervalli;
			loop
				fetch intervalli into intervallo_id;
				exit when not found;
	
				update intervallo
				set inizio = inizio + durata, fine = fine + durata
				where id_intervallo = intervallo_id;
			end loop;
			close intervalli;
			
			open eventi;
			loop
				fetch eventi into evento_id;
				exit when not found;
	
				update evento
				set inizio = inizio + durata, fine = fine + durata
				where id_evento = evento_id;
			end loop;
			close eventi;
		end loop;
		close sessioni;
        alter table conferenza enable trigger all;
        alter table sessione enable trigger all;
        alter table intervento enable trigger all;
        alter table intervallo enable trigger all;
        alter table evento enable trigger all;
        alter table programma enable trigger all;
        raise notice 'Slittamento completato';
	exception
		when others then
			raise notice '%', sqlerrm;
	end;
	$$ language plpgsql;
\end{lstlisting}

\subsection{\texttt{Show\_members(integer)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_members(conferenza_id integer)
returns table 
(
    id integer, 
    nome text, 
    cognome text, 
    email text,
    titolo titolo_st, 
    sigla varchar(7)
) 
as $$
begin
    return query
    select o.id_organizzatore, o.nome, o.cognome, o.email,o.titolo, e.sigla
    from organizzatore o natural join ente_conferenza ec natural join ente e  
    where ec.id_conferenza = conferenza_id
    group by e.sigla;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_percentage\_interventi(INTEGER,INTEGER)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_percentage_interventi(mese int, anno int)
returns table
(
    ente text,
    percentuale text
) as $$
declare
    totale int;
begin
    select count(*) into totale
    from intervento
    where date_part('month',inizio) = mese and date_part('year',inizio) = anno;

    return query
    select e.nome, (count(*)*100/totale)::text || '%'
    from intervento i join speaker s 
    on i.id_speaker = s.id_speaker join ente e 
    on s.id_ente = e.id_ente
    where date_part('month',inizio) = mese and date_part('year',inizio) = anno
    group by e.nome;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_percentage(INTEGER)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_percentage_interventi(anno int)
returns table
(
    nome varchar(7),
    percentuale text
) as $$
declare
    totale int;
begin
    select count(*) into totale
    from intervento
    where date_part('year',inizio) = anno;

    return query
    select e.nome, (count(*)*100/totale)::text || '%'
    from intervento i join speaker s 
    on i.id_speaker = s.id_speaker join ente e 
    on s.id_ente = e.id_ente
    where date_part('year',inizio) = anno
    group by e.nome;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Membro\_Comitato(integer,integer)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure add_membro_comitato(organizzatore_id integer, comitato_id integer)
as $$
begin
    insert into membro_comitato values (organizzatore_id,comitato_id);
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Show\_Membri\_Comitato(integer)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_membri_comitato(comitato_id integer)
returns table
(
    id integer,
    nome text,
    cognome text,
    email text,
    titolo titolo_st
) as $$
begin
    return query
    select o.id_organizzatore, o.nome, o.cognome, o.email, o.titolo
    from organizzatore o natural join membro_comitato mc
    where mc.id_comitato = comitato_id;
end;
$$ language plpgsql;
\end{lstlisting}
\subsection{\texttt{Add\_Membri\_Comitato(text,int)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace procedure add_membri_comitato(organizzatori text, comitato integer)
as $$
declare
    id_organizzatore integer;
begin
    for id_organizzatore in select unnest(string_to_array(organizzatori,','))::integer
    loop
        call add_membro_comitato(id_organizzatore,comitato);
    end loop;
    exception
        when others then
            raise notice '%', sqlerrm;
end;
$$
language plpgsql;

\end{lstlisting}
\subsection{\texttt{Show\_Sedi\_Libere(timestamp,timestamp)}}
\begin{lstlisting}[language=SQL,style=mystyle]
create or replace function show_sedi_libere(inizio_c timestamp, fine_c timestamp)
returns table(
    id_sede integer,
    nome text
) as $$
begin
    return query
    select s.id_sede, s.nome
    from sede s
    where not exists
    (
        select *
        from sala s1
        where s1.id_sede = s.id_sede and
        exists
        (
            select *
            from sessione s2
            where s2.id_sala = s1.id_sala and
            (s2.inizio>=inizio_c and s2.inizio<=fine_c)
        )
    );
end;
$$ language plpgsql;
\end{lstlisting}